name: ðŸ·ï¸ Auto Label Management - Smart Labeling

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  issues: write
  pull-requests: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ·ï¸ Auto-Label Issues
      if: github.event.issue
      run: |
        ISSUE_NUMBER="${{ github.event.issue.number }}"
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        
        echo "Processing issue #$ISSUE_NUMBER: $ISSUE_TITLE"
        
        # í˜„ìž¬ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
        CURRENT_LABELS=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[].name' | tr '\n' ' ')
        echo "Current labels: $CURRENT_LABELS"
        
        # ì¶”ê°€í•  ë¼ë²¨ ë°°ì—´
        declare -a LABELS_TO_ADD=()
        
        # ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
        if echo "$ISSUE_TITLE" | grep -qi "\[IMPLEMENTATION\]\|\[DEV\]"; then
          LABELS_TO_ADD+=("implementation" "dev")
        elif echo "$ISSUE_TITLE" | grep -qi "\[TESTING\]\|\[TEST\]"; then
          LABELS_TO_ADD+=("testing" "quality")
        elif echo "$ISSUE_TITLE" | grep -qi "\[INTEGRATION\]"; then
          LABELS_TO_ADD+=("integration" "api")
        fi
        
        # ëª¨ë“ˆ íƒ€ìž… ê¸°ë°˜ ë¼ë²¨ë§
        if echo "$ISSUE_TITLE" | grep -qi "database\|db\|migration"; then
          LABELS_TO_ADD+=("database")
        elif echo "$ISSUE_TITLE" | grep -qi "auth\|authentication\|security"; then
          LABELS_TO_ADD+=("security" "auth")
        elif echo "$ISSUE_TITLE" | grep -qi "api\|service\|endpoint"; then
          LABELS_TO_ADD+=("api" "backend")
        elif echo "$ISSUE_TITLE" | grep -qi "frontend\|ui\|react\|vue"; then
          LABELS_TO_ADD+=("frontend" "ui")
        fi
        
        # ë³¸ë¬¸ ê¸°ë°˜ ë¼ë²¨ë§
        if echo "$ISSUE_BODY" | grep -qi "high.priority\|urgent\|critical"; then
          LABELS_TO_ADD+=("priority-high")
        elif echo "$ISSUE_BODY" | grep -qi "low.priority"; then
          LABELS_TO_ADD+=("priority-low")
        else
          LABELS_TO_ADD+=("priority-medium")
        fi
        
        # ìžë™ ìƒì„±ëœ ì´ìŠˆì¸ì§€ í™•ì¸
        if echo "$ISSUE_BODY" | grep -qi "auto.*generated\|orchestrator"; then
          LABELS_TO_ADD+=("auto-generated" "claude-task")
        fi
        
        # ë¼ë²¨ ì¶”ê°€
        if [ ${#LABELS_TO_ADD[@]} -gt 0 ]; then
          LABELS_STRING=$(IFS=','; echo "${LABELS_TO_ADD[*]}")
          echo "Adding labels: $LABELS_STRING"
          
          gh issue edit $ISSUE_NUMBER --add-label "$LABELS_STRING"
          
          # ì½”ë©˜íŠ¸ ì¶”ê°€
          gh issue comment $ISSUE_NUMBER --body "ðŸ·ï¸ **Auto-labeling completed**

Added labels: \`$(echo "${LABELS_TO_ADD[@]}" | tr ' ' '\`, \`')\`

These labels help organize and prioritize tasks in the auto-development pipeline."
        else
          echo "No additional labels needed"
        fi
        
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: ðŸ·ï¸ Auto-Label Pull Requests
      if: github.event.pull_request
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BODY="${{ github.event.pull_request.body }}"
        
        echo "Processing PR #$PR_NUMBER: $PR_TITLE"
        
        # ì¶”ê°€í•  ë¼ë²¨ ë°°ì—´
        declare -a LABELS_TO_ADD=()
        
        # ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
        if echo "$PR_TITLE" | grep -qi "\[IMPLEMENTATION\]\|\[DEV\]"; then
          LABELS_TO_ADD+=("implementation" "dev")
        elif echo "$PR_TITLE" | grep -qi "\[TESTING\]\|\[TEST\]"; then
          LABELS_TO_ADD+=("testing" "quality")
        elif echo "$PR_TITLE" | grep -qi "\[INTEGRATION\]"; then
          LABELS_TO_ADD+=("integration" "api")
        fi
        
        # PR ë³¸ë¬¸ì—ì„œ ìžë™ ìƒì„± ì—¬ë¶€ í™•ì¸
        if echo "$PR_BODY" | grep -qi "auto.*generated\|claude.code"; then
          LABELS_TO_ADD+=("auto-generated" "ready-for-review")
        fi
        
        # ë³€ê²½ íŒŒì¼ ê¸°ë°˜ ë¼ë²¨ë§ (GitHub API ì‚¬ìš©)
        CHANGED_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path')
        
        if echo "$CHANGED_FILES" | grep -q "\.java$\|\.kt$"; then
          LABELS_TO_ADD+=("java" "backend")
        elif echo "$CHANGED_FILES" | grep -q "\.py$"; then
          LABELS_TO_ADD+=("python" "backend")
        elif echo "$CHANGED_FILES" | grep -q "\.js$\|\.ts$\|\.jsx$\|\.tsx$"; then
          LABELS_TO_ADD+=("javascript" "frontend")
        fi
        
        if echo "$CHANGED_FILES" | grep -q "test\|spec"; then
          LABELS_TO_ADD+=("testing")
        fi
        
        if echo "$CHANGED_FILES" | grep -q "\.sql$\|migration"; then
          LABELS_TO_ADD+=("database")
        fi
        
        if echo "$CHANGED_FILES" | grep -q "\.md$\|README\|doc"; then
          LABELS_TO_ADD+=("documentation")
        fi
        
        # ë¼ë²¨ ì¶”ê°€
        if [ ${#LABELS_TO_ADD[@]} -gt 0 ]; then
          LABELS_STRING=$(IFS=','; echo "${LABELS_TO_ADD[*]}")
          echo "Adding labels: $LABELS_STRING"
          
          gh pr edit $PR_NUMBER --add-label "$LABELS_STRING"
        else
          echo "No additional labels needed for PR"
        fi
        
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: ðŸ“Š Summary
      run: |
        if [ "${{ github.event.issue }}" ]; then
          echo "## ðŸ·ï¸ Issue Auto-Labeling Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title**: ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event.pull_request }}" ]; then
          echo "## ðŸ·ï¸ PR Auto-Labeling Complete" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Smart labeling completed automatically!" >> $GITHUB_STEP_SUMMARY
