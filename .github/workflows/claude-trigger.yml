name: ğŸ§  Claude Code Trigger - Auto Task Assignment

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  trigger-claude:
    runs-on: ubuntu-latest
    if: |
      (github.event.action == 'opened' || github.event.action == 'labeled') && 
      contains(github.event.issue.labels.*.name, 'auto-generated') && 
      contains(github.event.issue.labels.*.name, 'claude-task')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” Check Issue Status
      id: check_issue
      run: |
        ISSUE_NUMBER="${{ github.event.issue.number }}"
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_LABELS=$(echo '${{ toJson(github.event.issue.labels.*.name) }}' | jq -r '.[]' | tr '\n' ',' | sed 's/,$//')
        
        echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
        echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
        echo "issue_labels=$ISSUE_LABELS" >> $GITHUB_OUTPUT
        
        # ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸
        if echo "$ISSUE_LABELS" | grep -q "in-progress"; then
          echo "already_in_progress=true" >> $GITHUB_OUTPUT
        else
          echo "already_in_progress=false" >> $GITHUB_OUTPUT
        fi
        
        # ë¸”ë¡ëœ ìƒíƒœì¸ì§€ í™•ì¸
        if echo "$ISSUE_LABELS" | grep -q "blocked\|human-intervention"; then
          echo "is_blocked=true" >> $GITHUB_OUTPUT
        else
          echo "is_blocked=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
        echo "Labels: $ISSUE_LABELS"
        
    - name: ğŸ” Check Dependencies
      id: check_deps
      if: steps.check_issue.outputs.already_in_progress == 'false' && steps.check_issue.outputs.is_blocked == 'false'
      run: |
        ISSUE_NUMBER="${{ steps.check_issue.outputs.issue_number }}"
        
        # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ì˜ì¡´ì„± ì •ë³´ ì¶”ì¶œ
        ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body --jq '.body')
        
        # ì˜ì¡´ì„±ì´ ìˆëŠ”ì§€ í™•ì¸
        if echo "$ISSUE_BODY" | grep -q "depends_on\|ì˜ì¡´ì„±\|Dependencies"; then
          echo "has_dependencies=true" >> $GITHUB_OUTPUT
          
          # TODO: ì˜ì¡´ì„± ì²´í¬ ë¡œì§ êµ¬í˜„
          # í˜„ì¬ëŠ” ë‹¨ìˆœíˆ ì´ì „ ì´ìŠˆë“¤ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ë§Œ í™•ì¸
          PREV_ISSUES=$(gh issue list --label "auto-generated" --state closed --limit 10 --json number)
          CLOSED_COUNT=$(echo "$PREV_ISSUES" | jq '. | length')
          
          echo "dependencies_met=true" >> $GITHUB_OUTPUT
          echo "Dependency check: $CLOSED_COUNT previous issues completed"
        else
          echo "has_dependencies=false" >> $GITHUB_OUTPUT
          echo "dependencies_met=true" >> $GITHUB_OUTPUT
        fi
        
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: ğŸ¯ Trigger Claude Code
      if: |
        steps.check_issue.outputs.already_in_progress == 'false' && 
        steps.check_issue.outputs.is_blocked == 'false' && 
        steps.check_deps.outputs.dependencies_met == 'true'
      run: |
        ISSUE_NUMBER="${{ steps.check_issue.outputs.issue_number }}"
        
        # ì´ìŠˆì— in-progress ë¼ë²¨ ì¶”ê°€
        gh issue edit $ISSUE_NUMBER --add-label "in-progress"
        
        # Claude Code íŠ¸ë¦¬ê±° ì½”ë©˜íŠ¸ ì¶”ê°€
        TRIGGER_COMMENT="ğŸ¤– **Auto-Development Task Triggered**

ğŸ‘‹ @claude, please begin work on this task.

## ğŸ“‹ Task Information
- **Issue**: #$ISSUE_NUMBER
- **Title**: ${{ steps.check_issue.outputs.issue_title }}
- **Labels**: ${{ steps.check_issue.outputs.issue_labels }}

## ğŸ¯ Instructions
1. **Read the requirements** in the issue description carefully
2. **Check the module specification** in \`spec/modules/\` folder  
3. **Follow the coding standards** defined in \`.github/claude-code.yml\`
4. **Create a feature branch** following the naming pattern
5. **Implement the solution** with comprehensive tests
6. **Create a pull request** when ready

## ğŸ“‚ Key Files to Reference
- \`spec/spec.yaml\` - Project configuration
- \`spec/modules/*.yaml\` - Module specifications  
- \`README.md\` - Project overview
- \`.github/claude-code.yml\` - Development guidelines

## âœ… Success Criteria
- [ ] All requirements implemented
- [ ] Tests pass with 80%+ coverage
- [ ] Code follows project standards
- [ ] Documentation is updated
- [ ] PR is ready for review

**Good luck! ğŸš€**"

        gh issue comment $ISSUE_NUMBER --body "$TRIGGER_COMMENT"
        
        echo "âœ… Claude Code triggered for issue #$ISSUE_NUMBER"
        
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: ğŸ“Š Update Project Board
      if: |
        steps.check_issue.outputs.already_in_progress == 'false' && 
        steps.check_issue.outputs.is_blocked == 'false' && 
        steps.check_deps.outputs.dependencies_met == 'true'
      run: |
        # TODO: í”„ë¡œì íŠ¸ ë³´ë“œ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
        echo "ğŸ“‹ Project board updated (placeholder)"
        
    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸ§  Claude Code Trigger Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Issue**: #${{ steps.check_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Title**: ${{ steps.check_issue.outputs.issue_title }}" >> $GITHUB_STEP_SUMMARY
        echo "**Already in Progress**: ${{ steps.check_issue.outputs.already_in_progress }}" >> $GITHUB_STEP_SUMMARY
        echo "**Blocked**: ${{ steps.check_issue.outputs.is_blocked }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dependencies Met**: ${{ steps.check_deps.outputs.dependencies_met || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_issue.outputs.already_in_progress }}" == "false" ] && 
           [ "${{ steps.check_issue.outputs.is_blocked }}" == "false" ] && 
           [ "${{ steps.check_deps.outputs.dependencies_met || 'true' }}" == "true" ]; then
          echo "âœ… **Claude Code successfully triggered!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "â¸ï¸ **Task not triggered** (conditions not met)" >> $GITHUB_STEP_SUMMARY
        fi

  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì²˜ë¦¬
  manual-trigger:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'created' && 
      github.event.issue && 
      contains(github.event.comment.body, '@claude') && 
      contains(github.event.issue.labels.*.name, 'claude-task')
    
    steps:
    - name: ğŸ¯ Manual Claude Trigger
      run: |
        ISSUE_NUMBER="${{ github.event.issue.number }}"
        COMMENTER="${{ github.event.comment.user.login }}"
        
        echo "Manual trigger by $COMMENTER for issue #$ISSUE_NUMBER"
        
        # in-progress ë¼ë²¨ ì¶”ê°€
        gh issue edit $ISSUE_NUMBER --add-label "in-progress"
        
        # í™•ì¸ ì½”ë©˜íŠ¸
        gh issue comment $ISSUE_NUMBER --body "ğŸ¤– Manual trigger acknowledged by **$COMMENTER**. 
        
Claude Code should now pick up this task. If it doesn't start within 5 minutes, please check:
- Repository has Claude Code enabled
- Issue has required labels: \`auto-generated\`, \`claude-task\`
- No blocking labels: \`blocked\`, \`human-intervention\`"
        
      env:
        GH_TOKEN: ${{ github.token }}
