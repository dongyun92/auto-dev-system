name: Infinite Loop Prevention
on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, closed]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  check-loops:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Detect Issue Creation Loops
        id: issue_loops
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);
            
            // Get recent issues
            const { data: recentIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: sixHoursAgo.toISOString(),
              per_page: 100
            });
            
            // Count issues by title pattern
            const titleCounts = {};
            recentIssues.forEach(issue => {
              const titlePattern = issue.title.replace(/\d+/g, 'X'); // Replace numbers with X
              titleCounts[titlePattern] = (titleCounts[titlePattern] || 0) + 1;
            });
            
            // Find potential loops (same pattern > 5 times)
            const loops = Object.entries(titleCounts).filter(([pattern, count]) => count > 5);
            
            if (loops.length > 0) {
              core.setOutput('has_loops', 'true');
              core.setOutput('loop_patterns', JSON.stringify(loops));
              
              // Create warning comment on latest issue
              const latestIssue = recentIssues.find(i => i.state === 'open');
              if (latestIssue) {
                const warningComment = \`
## ðŸ”„ ë¬´í•œë£¨í”„ ê°ì§€
                
**ê°ì§€ëœ íŒ¨í„´**: \${loops.map(([p, c]) => \`"\${p}" (x\${c})\`).join(', ')}
                
### ðŸš¨ ìžë™í™” ì¼ì‹œ ì¤‘ë‹¨
ì‹œìŠ¤í…œì´ ë™ì¼í•œ ì´ìŠˆë¥¼ ë°˜ë³µ ìƒì„±í•˜ê³  ìžˆìŠµë‹ˆë‹¤. 
ìžë™í™”ë¥¼ ì¼ì‹œ ì¤‘ë‹¨í•˜ê³  ì›ì¸ì„ ì¡°ì‚¬í•©ë‹ˆë‹¤.
                
### ðŸ”§ í•´ê²° ë°©ë²•
1. ì¤‘ë³µ ì´ìŠˆë“¤ í™•ì¸ ë° ì •ë¦¬
2. YAML ìŠ¤íŽ™ ê²€í† 
3. Orchestrator ë¡œì§ ì ê²€
4. \`loop-detected\` ë¼ë²¨ ì œê±° í›„ ìž¬ê°œ
                
---
*ðŸ¤– ìžë™ ê°ì§€ ì‹œìŠ¤í…œ*
                \`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: latestIssue.number,
                  body: warningComment
                });
                
                // Add loop-detected label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: latestIssue.number,
                  labels: ['loop-detected', 'system-alert']
                });
              }
            } else {
              core.setOutput('has_loops', 'false');
            }
            
            return loops.length;
            
      - name: Detect PR Creation Loops
        id: pr_loops
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);
            
            // Get recent PRs
            const { data: recentPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });
            
            const recentPRsFiltered = recentPRs.filter(pr => 
              new Date(pr.created_at) > sixHoursAgo
            );
            
            // Check for rapid PR creation by same author
            const authorCounts = {};
            recentPRsFiltered.forEach(pr => {
              const author = pr.user.login;
              authorCounts[author] = (authorCounts[author] || 0) + 1;
            });
            
            // Check for Claude Code bot creating too many PRs
            const claudePRs = authorCounts['claude-code[bot]'] || authorCounts['github-actions[bot]'] || 0;
            
            if (claudePRs > 10) {
              core.setOutput('has_pr_loops', 'true');
              core.setOutput('claude_pr_count', claudePRs);
              
              // Create system alert issue
              const alertBody = \`
# ðŸš¨ PR ìƒì„± ë£¨í”„ ê°ì§€

## ðŸ“Š ê°ì§€ ë‚´ìš©
- **ì‹œê°„ëŒ€**: ìµœê·¼ 6ì‹œê°„
- **PR ê°œìˆ˜**: \${claudePRs}ê°œ
- **ìž„ê³„ê°’**: 10ê°œ ì´ˆê³¼

## ðŸ›‘ ìžë™ ì¡°ì¹˜
1. ìƒˆë¡œìš´ ìžë™ PR ìƒì„± ì¤‘ë‹¨
2. ì‹œìŠ¤í…œ ê´€ë¦¬ìž ì•Œë¦¼
3. ìˆ˜ë™ ê²€í†  í•„ìš”

## ðŸ”§ ê¶Œìž¥ ì¡°ì¹˜
1. ìµœê·¼ PRë“¤ì˜ íŒ¨í„´ ë¶„ì„
2. Claude Code ì„¤ì • ì ê²€
3. ì¤‘ë³µ/ì‹¤íŒ¨ PR ì •ë¦¬
4. ì‹œìŠ¤í…œ ìž¬ì‹œìž‘

---
*ìžë™ ê°ì§€ ì‹œê°„: \${new Date().toISOString()}*
              \`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ System Alert: PR Creation Loop Detected',
                body: alertBody,
                labels: ['system-alert', 'urgent', 'loop-detected']
              });
            } else {
              core.setOutput('has_pr_loops', 'false');
            }
            
            return claudePRs;
            
      - name: Check Resource Usage
        id: resource_check
        uses: actions/github-script@v7
        with:
          script: |
            // Check workflow run count (API usage)
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              created: \`>\${oneHourAgo.toISOString()}\`,
              per_page: 100
            });
            
            const runCount = workflowRuns.total_count;
            
            if (runCount > 50) {
              core.setOutput('high_usage', 'true');
              core.setOutput('run_count', runCount);
              
              // Create usage warning
              const warningBody = \`
## âš ï¸ ë†’ì€ ì‹œìŠ¤í…œ ì‚¬ìš©ëŸ‰ ê°ì§€

**ìµœê·¼ 1ì‹œê°„ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰**: \${runCount}íšŒ  
**ìž„ê³„ê°’**: 50íšŒ ì´ˆê³¼

### ðŸŽ›ï¸ ê¶Œìž¥ ì¡°ì¹˜
1. ë¶ˆí•„ìš”í•œ íŠ¸ë¦¬ê±° ì œê±°
2. ì›Œí¬í”Œë¡œìš° ìµœì í™”
3. ë°°ì¹˜ ì²˜ë¦¬ ê³ ë ¤

ì‹œìŠ¤í…œ ì‚¬ìš©ëŸ‰ì´ ë†’ì•„ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
              \`;
              
              // Add comment to latest open issue
              const { data: openIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 1
              });
              
              if (openIssues.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: openIssues[0].number,
                  body: warningBody
                });
              }
            }
            
            return runCount;
            
      - name: Update Automation Block
        if: steps.issue_loops.outputs.has_loops == 'true' || steps.pr_loops.outputs.has_pr_loops == 'true'
        run: |
          # Create or update automation block file
          cat > .automation-blocked << EOF
          {
            "reason": "Infinite loop detected",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "issue_loops": "${{ steps.issue_loops.outputs.has_loops }}",
            "pr_loops": "${{ steps.pr_loops.outputs.has_pr_loops }}",
            "loop_patterns": ${{ steps.issue_loops.outputs.loop_patterns || '[]' }},
            "auto_resume": false
          }
          EOF
          
          # Commit the block
          git config user.name "Loop Detection System"
          git config user.email "system@auto-dev.local"
          git add .automation-blocked
          git commit -m "ðŸš¨ SYSTEM: Block automation due to detected loops" || true
          git push || true
          
      - name: Cleanup Old Issues (if loops detected)
        if: steps.issue_loops.outputs.has_loops == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const loopPatterns = JSON.parse('${{ steps.issue_loops.outputs.loop_patterns }}');
            
            for (const [pattern, count] of loopPatterns) {
              // Find issues matching this pattern
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              const matchingIssues = issues.filter(issue => {
                const titlePattern = issue.title.replace(/\d+/g, 'X');
                return titlePattern === pattern;
              });
              
              // Close all but the latest one
              if (matchingIssues.length > 1) {
                const latestIssue = matchingIssues[0]; // GitHub returns newest first
                const duplicateIssues = matchingIssues.slice(1);
                
                for (const duplicate of duplicateIssues) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: duplicate.number,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: duplicate.number,
                    body: \`ðŸ”„ Closed as duplicate due to loop detection. See #\${latestIssue.number} for the active issue.\`
                  });
                }
              }
            }